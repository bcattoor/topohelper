============================
Rails to Railway Center Line
============================

Gebruik
-------

Workflow
^^^^^^^^
Om een voorbeeld te volgen waarin we van begin naar eind gaan, alsook de effectiviteit verdedigen, kan je deze :ref:`workflow gebruiken<WorkflowCRC>`. Ook "bewijzen" we daar de werking.

Stap 1: Commando
^^^^^^^^^^^^^^^^
In autocad start het commando ``IAMTopo_Rails2RailwayCenterLine.``

Stap 2: Selecteer de rails
^^^^^^^^^^^^^^^^^^^^^^^^^^
Selecteer de linkerrail en dan selecteer je de rechter rail. Deze polylijnen bevatten alle opgemeten punten van de rail. De railpunten worden steeds loodrecht tenopzichte van elkaar aangeleverd.

Stap 3: Controle van de invoer
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Een controle wordt uitgevoerd op de door u aangeleverde invoer. Dit om te kijken of de functie kan worden verder gezet.

.. tip:: Zorg ervoor dat je de commandoregel in het oog houd, deze houdt je op de hoogte van het verloop.


Deze controles zijn:
====================

- zijn de geselecteerde polylijnen uniek t.o.v. elkaar
- zijn het aantal definieërende (*in AutoCAD noemen we dit Vertexten*) punten gelijk
- zijn er genoeg punten op de ploylijnen, lees meer dan 2 punten per polylijn
- is de richting t.o.v. elkaar gelijk
- voldoen de spoorwijdtes aan de minimum opgegeven waarde
    .. seealso:: 
        - In de instellingen is de volgende waarde aan te passen: DataValidation_LeftrailToRightRail_Tolerance
            - Wanneer de afstand kleiner is dan 1.435 - ``DataValidation_LeftrailToRightRail_Tolerance``, dan geven we een *foutmelding*.

- voldoen de spoorwijdtes aan de maximum opgegeven waarde, hiermee bedoelen we de 3D afstand tussen het linker rail punt, en het rechter rail punt.
    .. seealso:: 
        - DataValidation_LeftrailToRightRail_Maximum
        - Wanneer de afstand grooter is dan ``DataValidation_LeftrailToRightRail_Maximum`` + ``DataValidation_LeftrailToRightRail_Tolerance``, dan geven we een *foutmelding*.

Wanneer **alle controles in orde zijn** kunnen we verder.

Stap 5: Corrigeren waarde i.v.m. de scheefstand van de bolprismas
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Wanneer de waarde van de variabel ``Rails2RailwayCenterLine_Use_CalculateSurveyCorrection`` is ingeschakeld (waarde ``= True``), dan wordt de correctie berekend voor het rekening houden met de scheefstand van de bolprisma’s.

.. seealso:: Aan de hand van een lijst van punten (linker rail punten, en rechter railpunten), berekenen we de verplaatsing die moet worden toegepast voor iedere sectie. We gebruiken de verkanting om zo de benodigde verplaatsing te berekenen. Hoe dit presies in elkaar steekt kun je in `de broncode terugvinden`_ . Let wel op, enkel de scheeftstandverplaating wordt hier berekend, niet de hoogte van het prisma t.o.v. de lat.

.. _`de broncode terugvinden`: https://github.com/bcattoor/topohelper/blob/87b1fc0b50eca76353e0c1723cf24b427312fe22/TopoHelper/Model/Calculations/SurveyCorrection.cs#L22

Een resultaat van de uitgevoerde berekeningen kan ter controle worden weggeschreven naar een csv-bestand. Gebruik hiervoor de variabele ``DistanceBetween2Polylines_PathToCsvFile`` om de bestandslocatie op te geven.

Stap 6: Berekenen van de aslijn van het spoor
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Aan de hand van de railpunten berekenen we nu de centerlijn van het spoor. Dit is gewoon het midden tussen de twee 3D punten. Voor de hoogte gebruiken we steeds het laagste railbeen

.. warning:: Correcter zou zijn om steeds de rail-binnenkant-bocht te gebruiken voor de hoogte. Maar ik ben er nog niet in geslaagd om dat op een correcte manier toe te passen.

STAP 7: Uitteken van de resultaten naar de tekening
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Alle lijnen/punten worden uitgetekend in de DWG en dat **volgens de ingestelde standaarden**. Alle instellingen ivm de lagen/kleuren/... kan je aanpassen in het :ref:`IAMTopo_Settings`.

STAP 8: Uitsturen van het resultaat naar een CSV bestand
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Indien zo ingesteld worden er CSV-bestanden weggeschreven naar de in de instellingen opgegeven locaties. Deze bestanden bevatten de berekende waarden van de uitgevoerde functies.

.. Note:: Momenteel wordt een bestand berekend met de gegevens i.v.m. de uitgevoerde correcties in STAP 5. En i.v.m. de gegevens berekend in STAP 6.

.. TODO: Toon hoe je view.xlsx kan gebruiken om de waarden te interpreteren.

Waarom is deze functie nodig
----------------------------

Wanneer een operator een spoorlijn gaat opmeten, dan vraagt de dienst sporen om de volgende zaken op te meten:

* De as van het spoor volgens RTVB B1.1
* De linker rail (in bocht, of bij een verkanting)
* De rechter rail (in bocht, of bij een verkanting)

Er moeten dus drie punten worden opgemeten.

De spoor-as kan worden berekend aan de hand van de opgemeten rails.

Meer info i.v.m. deze methode: spoor-definitie beschreven in de RTVB B1.1: Design van het spoor (Bericht 24 I-AM/2014).

Momenteel beschikken we binnen AutoCAD niet over een routine die deze berekening maakt.

Hoe moeten de gegevens worden aangeleverd
-----------------------------------------

De opmeter levert ons een AutoCAD bestand aan die de volgende zaken bevat:

- 3d polylijn van beide assen van de rail, opgebouwd door het verbinden van alle opgemeten punten (X,Y,Z [#TAW]_)
    .. warning:: Alle vertexen die deel uitmaken van de polylijn worden als opgemeten punten beschouwd! Voeg dus geen punten toe die niet werkelijk zijn opgemeten! Zijn er toch extra "berekende" punten toegevoed aan de lijn, gebruik dan deze functie om ze te verwijderen: :ref:`IAMTopo_CleanNonSurveyVertexFromPolyline`.

- Alle opgemeten punten, in hun eigen laag. 
    .. note::
    
        Deze punten worden voorgesteld door gebruik te maken van AutoCAD blokken. 
        We hebben het liefst blokken met als attribuut de naam (NAME), en als insertiepunt: Z [#TAW]_ X en Y.
        Er mag steeds meer informatie beteffede de opgemeten punten worden toegevoegd, *bovenstaand is een minimum.*

- De punten zijn in eenzelfde sectie opgemeten, d.w.z. de punten staan loodrecht tegenover elkaar t.o.v. de spooras.
- De aangeleverde opmeting wordt opgemeten in Lambert72 [#EPGS-31370]_

.. rubric:: Voetnoot

.. [#TAW] Tweede algemene waterpassing: https://www.ngi.be/website/tweede-algemene-waterpassing/
.. [#EPGS-31370] Belge_1972_Belgian_Lambert_72: http://epsg.io/31370